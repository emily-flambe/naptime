#!/bin/sh
# TruffleHog pre-commit hook to prevent secrets from being committed
# This hook runs before every commit to scan for potential secrets

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Running TruffleHog secret detection..."

# Check if Docker is available (required for this project)
if ! command -v docker &> /dev/null; then
    echo "${RED}‚ö†Ô∏è  Docker is not available!${NC}"
    echo ""
    echo "Docker is required for this project. Please install Docker Desktop:"
    echo "  https://www.docker.com/products/docker-desktop"
    echo ""
    echo "Skipping secret scanning for this commit."
    exit 0
fi

# Run TruffleHog using Docker
docker run --rm -v "$(pwd):/workdir" -i \
    trufflesecurity/trufflehog:latest \
    git file:///workdir \
    --since-commit HEAD \
    --results=verified \
    --fail \
    --exclude-paths /workdir/.trufflehog-ignore 2>/dev/null

SCAN_RESULT=$?

if [ $SCAN_RESULT -ne 0 ]; then
    echo ""
    echo "${RED}‚ö†Ô∏è  SECRETS DETECTED!${NC}"
    echo ""
    echo "TruffleHog has detected potential secrets in your commit."
    echo "Please take the following actions:"
    echo ""
    echo "1. Remove the sensitive information from your code"
    echo "2. Move secrets to environment variables (.env file)"
    echo "3. Add the variable name to .env.example with a placeholder"
    echo "4. If this is a false positive, see .project/docs/explainers/trufflehog-secret-detection.md"
    echo ""
    echo "For more information, run: make scan-secrets"
    exit 1
fi

echo "${GREEN}‚úÖ No secrets detected. Proceeding with commit.${NC}"