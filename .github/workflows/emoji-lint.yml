name: Emoji Linter

on:
  pull_request:
    branches: [main]
  push:
    branches-ignore: [main]

jobs:
  emoji-lint:
    name: Check for emojis in codebase
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install emoji-linter
        run: npm install -g @emily-flambe/emoji-linter || npm install -g emoji-linter
        
      - name: Run Emoji Linter
        run: |
          echo "Running emoji-linter check..."
          emoji-linter check --config .emoji-linter.config.json || echo "emoji-linter command failed, trying alternative..."
          
          # If direct CLI fails, try with npx
          if ! emoji-linter check --config .emoji-linter.config.json 2>/dev/null; then
            echo "Direct CLI failed, checking for emojis manually..."
            # Simple emoji detection as fallback
            if grep -r "[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]" --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" --include="*.py" --include="*.go" --include="*.java" --include="*.c" --include="*.cpp" --include="*.h" . 2>/dev/null; then
              echo "ERROR: Emojis found in codebase!"
              exit 1
            else
              echo "No emojis found in source code files."
            fi
          fi
        id: emoji-check
        
      - name: Report Results
        if: always()
        run: |
          echo "Has emojis: ${{ steps.emoji-check.outputs.has-emojis }}"
          echo "Emoji count: ${{ steps.emoji-check.outputs.emoji-count }}"
          echo "Files with emojis: ${{ steps.emoji-check.outputs.files-with-emojis }}"
          echo "Total files scanned: ${{ steps.emoji-check.outputs.total-files }}"
          
      - name: Fail if emojis found
        if: steps.emoji-check.outputs.has-emojis == 'true'
        run: |
          echo "ERROR: Emojis found in codebase! This violates the project's no-emoji policy."
          echo "Please remove all emojis from source code, comments, and documentation."
          exit 1